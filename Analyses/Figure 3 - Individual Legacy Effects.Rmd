---
title: "Figure 3: Individual Legacy Effects"
---

Libraries:
```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
lapply(c("mgcv", "gamm4", "rstanarm", "ggpubr", "ggplot2", "plyr", "dplyr", "mgcViz"), require, character.only = TRUE)
```

Import Data:
```{r message=FALSE, warning=FALSE, paged.print=FALSE}
source("source_file.R")
df = subset(df, legacy!="Democratic" & country != "Hungary" & country != "East Germany")
df$exp = NA; df$exp[df$exposure==0] = 0; df$exp[df$exposure>0] = 1
df$exp = factor(df$exp, levels = c(0,1), labels = c("No", "Yes"))
```

H2a: Experience
```{r}
h2a_gams = list()
h2a_gams_pred = list()

for (i in c(1:2)) {
 legacydata = subset(df, legacy == unique(df$legacy)[i])
 h2a_gams[[i]] = gam(autdem ~ s(lrscale, k = 10, by = exp), data = legacydata)
 h2a_gams_pred[[i]] = tidymv::predict_gam(h2a_gams[[i]])
 h2a_gams_pred[[i]]$legacy = unique(df$legacy)[i]
 capture.output(summary(h2a_gams[[i]]), 
                file = paste0(tab_dir, "h2a_", unique(df$legacy)[i], ".txt"))
}

h2a_gams_pred = do.call(rbind, h2a_gams_pred)
h2a_gams_pred$hypothesis = "H2a Experience"
colnames(h2a_gams_pred) = c("lrscale", "value", "fit", "se.fit", "legacy", "hypothesis")
```

H2b: Duration of Exposure
```{r}
h2b_gams = list()
h2b_gams_pred = list()

for (i in c(1:2)) {
 legacydata = subset(df, legacy == unique(df$legacy)[i])
 legacydata$exp_dec = round_any(legacydata$exposure, 10, f = ceiling)
 legacydata$exp_dec[legacydata$exposure == 0] = 0
 legacydata$exp_dec = factor(legacydata$exp_dec)
 h2b_gams[[i]] = gam(autdem ~ s(lrscale, k = 10, by = exp_dec), data = legacydata)
 h2b_gams_pred[[i]] = tidymv::predict_gam(h2b_gams[[i]])
 h2b_gams_pred[[i]]$legacy = unique(df$legacy)[i]
 capture.output(summary(h2b_gams[[i]]), 
                file = paste0(tab_dir, "h2b_", unique(df$legacy)[i], ".txt"))
}

h2b_gams_pred = do.call(rbind, h2b_gams_pred)
h2b_gams_pred$hypothesis = "H2b Duration"
colnames(h2b_gams_pred) = c("lrscale", "value", "fit", "se.fit", "legacy", "hypothesis")
```

H2c: Age of Exposure
```{r}
# exposure age: 1 = No Exposure, 2 = Adult Exposure, 3 = Full Exposure, 4 = Early Exposure 

df$exp_age = factor(df$exposure_age, levels = c(1:4), 
                    labels = c("No Exposure", 
                               "Adult Exposure", 
                               "Full Exposure",
                               "Early Exposure"))

h2c_gams = list()
h2c_gams_pred = list()

for (i in c(1:2)) {
 legacydata = subset(df, legacy == unique(df$legacy)[i])
 h2c_gams[[i]] = gam(autdem ~ s(lrscale, k = 10, by = exp_age), data = legacydata)
 h2c_gams_pred[[i]] = tidymv::predict_gam(h2c_gams[[i]])
 h2c_gams_pred[[i]]$legacy = unique(df$legacy)[i]
 capture.output(summary(h2c_gams[[i]]), 
                file = paste0(tab_dir, "h2c_", unique(df$legacy)[i], ".txt"))
}

h2c_gams_pred = do.call(rbind, h2c_gams_pred)
h2c_gams_pred$hypothesis = "H2c Exposure Age"
colnames(h2c_gams_pred) = c("lrscale", "value", "fit", "se.fit", "legacy", "hypothesis")
```

```{r}
summary(h2b_gams[[2]])
```


Effective Degrees of Freedom Statistics:
```{r}
edfs = data.frame(
 value = c("No", "Yes", 
           "No", "Yes", 
           "No Exposure", "Early Exposure",
           "No Exposure", "Early Exposure",
           "0", "30", "60",
           "0", "30", "50"),
 legacy = c("Left-Wing", "Left-Wing", 
            "Right-Wing", "Right-Wing",
            "Left-Wing", "Left-Wing", 
            "Right-Wing", "Right-Wing",
            "Left-Wing", "Left-Wing", "Left-Wing",
            "Right-Wing", "Right-Wing","Right-Wing"
            ),
 edf = c(1.000, 7.763,
         7.992, 6.408,
         1.000, 7.222,
         7.993, 5.399,
         1, 6.063, 6.471,
         7.995, 6.732, 1.000)
)

```

```{r}
library(gridExtra)
h2_pred = rbind(subset(rbind(h2a_gams_pred, h2b_gams_pred, h2c_gams_pred), legacy == "Left-Wing" & 
                 value != "Adult Exposure" & value != "Full Exposure" & 
                 value != "20" & value != "40" & value != "10" & value != "50" & value != "70"),
                subset(rbind(h2a_gams_pred, h2b_gams_pred, h2c_gams_pred), legacy == "Right-Wing" & 
                 value != "Adult Exposure" & value != "Full Exposure" & 
                 value != "10" & value != "20" & value != "40" & value != "60" & value != "70"))

h2_pred$lrscale_round = round(h2_pred$lrscale)
h2_pred = merge(h2_pred, edfs, by = c("value", "legacy"))

h2_pred$classes = paste0(h2_pred$hypothesis, ": ", h2_pred$legacy)
h2_pred$value = paste0(h2_pred$value, " (edf=", h2_pred$edf, ")")

xs = split(h2_pred,f = h2_pred$classes)

for (i in c(1:6)) {
 data = xs[[i]]
 data = data[order(data$lrscale),]
 xs[[i]] = data
}
```


```{r}
library(gridExtra)
library(tidymv)

p1 = ggplot(xs$`H2a Experience: Left-Wing`, aes(lrscale, fit, linetype = value)) + 
 geom_smooth_ci() + ylim(0,2.5) + 
 xlab("Left-Right Orientation") + ylab("Democratic Support") + 
 scale_x_continuous(breaks = c(1:10)) + 
 theme_minimal() + 
 facet_grid(.~classes) + 
 theme(legend.position = "bottom",
       panel.grid.minor = element_blank(),
       legend.title = element_blank(),
       legend.text = element_text(size = 8), 
       axis.title = element_blank(),
       strip.text = element_text(face = "bold", vjust = 3, size = 11))

p2 = p1 %+% xs$`H2a Experience: Right-Wing` 
p3 = p1 %+% xs$`H2b Duration: Left-Wing`
p4 = p1 %+% xs$`H2b Duration: Right-Wing`
p5 = p1 %+% xs$`H2c Exposure Age: Left-Wing`
p6 = p1 %+% xs$`H2c Exposure Age: Right-Wing`

grid.arrange(p1,p3,p5,p2,p4,p6, ncol = 3)

dev.copy(png,paste0(fig_dir, 'Figure 3 - Individual Legacy Effects.png'), width = 7000, height = 5500, res=600)
dev.off()
```






