---
title: "Table 3 - Individual Level Legacy Effects"
---

Import Libraries:
```{r message=FALSE, warning=FALSE, paged.print=FALSE}
library(lme4)
library(lmerTest)
library(boot)
library(lm.beta)
library(memisc)
library(plyr)
```

Import Data:
```{r message=FALSE, warning=FALSE, paged.print=FALSE}
source("source_file.R")
```

Functions:
```{r}
# intra-class correlation
icc0 = function(model) {
 varcorr = data.frame(VarCorr(model)); varcntry = subset(varcorr, grp == "country")
 varresidual = subset(varcorr, grp == "Residual"); icc = (varcntry$vcov) / (varcntry$vcov + varresidual$vcov)
 return(icc)
 }
```

Hypothesis 2a:
```{r}
h2a_models = list()
h2a_boots = list()

for (i in c(1:2)) {
 sub = subset(df, legacy == unique(df$legacy)[i])
 h2a_models[[i]] = lmer(autdem ~ lrscale + exp + lrscale*exp + survey + age + (1 | country), data=sub)
 h2a_boots[[i]] = confint(h2a_models[[i]], parm = c(3:11), method = "boot", nsim = 5000, seed = 1993, level = 0.9) 
}

for (i in c(1:2)) {
 names = c("m2b", "m2a")
 model = h2a_models[[i]]; model_boot = h2a_boots[[i]]
 out = data.frame(variable = c("intercept", "left-right", "experience", "evs2008", 
                        "wvs1994", "wvs1999", "wvs2005", "age", "lrscale*exp"),
           coeff = round(c(model@beta),3), se = round(coef(summary(model))[, "Std. Error"],3),
           lower = round(model_boot[,1],3), upper = round(model_boot[,2],3),
           icc = icc0(model)
           )
 out$b_se = paste0(format(out$coeff, 3), "(", format(out$se, 3), ")")
 out$ci = paste0("[", format(out$lower,3), ";", format(out$upper,3), "]")
 writexl::write_xlsx(out, paste0(tab_dir, names[i], ".xlsx"))
}
```

Hypothesis 2b:
```{r}
h2b_models = list()
h2b_boots = list()

for (i in c(1:2)) {
 sub = subset(df, legacy == unique(df$legacy)[i])
 h2b_models[[i]] = lmer(autdem ~ lrscale + exposure + lrscale*exposure + age_cat + 
                        survey + (1 | country), data=sub)
 h2b_boots[[i]] = confint(h2b_models[[i]], parm = c(3:13), method = "boot", 
                          nsim = 5000, seed = 1993, level = 0.9)
}

for (i in c(1:2)) {
 names = c("m3b", "m3a")
 model = h2b_models[[i]]; model_boot = h2b_boots[[i]]
 out = data.frame(variable = rownames(model_boot),
           coeff = round(c(model@beta),3), se = round(coef(summary(model))[, "Std. Error"],3),
           lower = round(model_boot[,1],3), upper = round(model_boot[,2],3),
           icc = icc0(model)
           )
 out$b_se = paste0(format(out$coeff, 3), "(", format(out$se, 3), ")")
 out$ci = paste0("[", format(out$lower,3), ";", format(out$upper,3), "]")
 writexl::write_xlsx(out, paste0(tab_dir, names[i], ".xlsx"))
}
```

Hypothesis 2c:
```{r}
h2c_models = list()
h2c_boots = list()

for (i in c(1:2)) {
 sub = subset(df, legacy == unique(df$legacy)[i])
 h2c_models[[i]] = lmer(autdem ~ lrscale + exposure_age + lrscale*exposure_age + age + 
                        survey + (1 | country), data=sub)
 h2c_boots[[i]] = confint(h2c_models[[i]], parm = c(3:15), method = "boot", 
                          nsim = 5000, seed = 1993, level = 0.9)
}

for (i in c(1:2)) {
 names = c("m4b", "m4a")
 model = h2c_models[[i]]; model_boot = h2c_boots[[i]]
 out = data.frame(variable = rownames(model_boot),
           coeff = round(c(model@beta),3), se = round(coef(summary(model))[, "Std. Error"],3),
           lower = round(model_boot[,1],3), upper = round(model_boot[,2],3),
           icc = icc0(model)
           )
 out$b_se = paste0(format(out$coeff, 3), "(", format(out$se, 3), ")")
 out$ci = paste0("[", format(out$lower,3), ";", format(out$upper,3), "]")
 writexl::write_xlsx(out, paste0(tab_dir, names[i], ".xlsx"))
}
```

